<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional-dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head id="ctl00_ctl00">
 

<meta name="description" content="Technology blog about new Microsoft technologies. E.g. WPF, crossbow, .NET framework 3, Live etc. It includes code sources and samples">
<meta name="keywords" content=".NET Framework, Example, Internals, Microsoft, Programming, Source Code, technology, tutorial, wpf.">
<meta name="GENERATOR" content="CommunityServer 2007 SP2 (Build: 20611.960)">
<link rel="pingback" href="http://blogs.microsoft.co.il/blogs/tamir/pingback.aspx">
<link rel="shortcut icon" type="image/ico" href="http://blogs.microsoft.co.il/favicon.ico">
<link rel="alternate" type="application/rss+xml" title="Just code - Tamir Khason (RSS 2.0)" href="http://feeds.feedburner.com/microsft">
<link rel="alternate" type="application/rss+xml" title="Just code - Tamir Khason - All Comments (RSS 2.0)" href="http://blogs.microsoft.co.il/blogs/tamir/rsscomments.aspx">
<link rel="alternate" type="application/rss+xml" title="Single instance application, screen saver and power management disabling and battery meter - Comments for this post (RSS 2.0)" href="http://blogs.microsoft.co.il/blogs/tamir/rsscomments.aspx?PostID=9622">

	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="screen%20saver%20and%20power%20management%20disabling_files/style.css" type="text/css" media="screen">
	<link rel="stylesheet" href="screen%20saver%20and%20power%20management%20disabling_files/print.htm" type="text/css" media="print">
	<link rel="stylesheet" href="screen%20saver%20and%20power%20management%20disabling_files/light_sidebar_left_wide.css" type="text/css" media="screen">
	<link rel="stylesheet" href="screen%20saver%20and%20power%20management%20disabling_files/DynamicStyle.css" type="text/css" media="screen">
<script src="screen%20saver%20and%20power%20management%20disabling_files/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-486526-1";
urchinTracker();
</script><title>Single instance application, screen saver and power management disabling and battery meter - Just code - Tamir Khason</title></head><body>
    <form name="aspnetForm" method="post" action="/blogs/tamir/archive/2007/03/06/Single-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx" onsubmit="javascript:return WebForm_OnSubmit();" id="aspnetForm">
<div>
<input name="__EVENTTARGET" id="__EVENTTARGET" value="" type="hidden">
<input name="__EVENTARGUMENT" id="__EVENTARGUMENT" value="" type="hidden">
<input name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTIwMjk4NDE1MzdkGAEFHl9fQ29udHJvbHNSZXF1aXJlUG9zdEJhY2tLZXlfXxYBBS5jdGwwMCRNYWluJGN0bDA4JGN0bDAyJGN0bDAyJGN0bDAyJGNoa1JlbWVtYmVyNnOa7G3ox0C7N39AE+DRj1GRFAw=" type="hidden">
</div>

<script type="text/javascript">
<!--
var theForm = document.forms['aspnetForm'];
if (!theForm) {
    theForm = document.aspnetForm;
}
function __doPostBack(eventTarget, eventArgument) {
    if (!theForm.onsubmit || (theForm.onsubmit() != false)) {
        theForm.__EVENTTARGET.value = eventTarget;
        theForm.__EVENTARGUMENT.value = eventArgument;
        theForm.submit();
    }
}
// -->
</script>


<script src="screen%20saver%20and%20power%20management%20disabling_files/WebResource.js" type="text/javascript"></script>


<script src="screen%20saver%20and%20power%20management%20disabling_files/WebResource_002.axd" type="text/javascript"></script>
<script src="screen%20saver%20and%20power%20management%20disabling_files/WebResource_004.axd" type="text/javascript"></script>
<script src="screen%20saver%20and%20power%20management%20disabling_files/WebResource_003.axd" type="text/javascript"></script>
<script src="screen%20saver%20and%20power%20management%20disabling_files/WebResource.axd" type="text/javascript"></script>
        
<script type="text/javascript">
<!--   
    function ValidateCaptcha(val, args) {
      
        var value = args.Value;
        var nameEQ = "CAPTCHA=";
        var captchaNumbers;        	
        var ca = document.cookie.split(';');
        
        for(var i=0;i < ca.length;i++) {
    	    var c = ca[i];
    	    while (c.charAt(0)==' ') c = c.substring(1,c.length);
    	    if (c.indexOf(nameEQ) == 0) captchaNumbers =  c.substring(nameEQ.length,c.length);
	    }

        args.IsValid = captchaNumbers == value;

    }
-->
</script>

<script src="screen%20saver%20and%20power%20management%20disabling_files/WebResource_002.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
function WebForm_OnSubmit() {
if (typeof(ValidatorOnSubmit) == "function" && ValidatorOnSubmit() == false) return false;
return true;
}
// -->
</script>


    			

    <div id="masthead">
        <div id="welcome" align="right">
            
        <a href="http://blogs.microsoft.co.il/login.aspx?ReturnUrl=%2fblogs%2ftamir%2farchive%2f2007%2f03%2f06%2fSingle-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx">Sign in </a>
         | <a href="http://blogs.microsoft.co.il/user/CreateUser.aspx?ReturnUrl=">Join</a>
        | <a href="http://communityserver.org/r.ashx?K">Help</a>
     


        </div>
    </div>
    <div id="wrapper">
	        <div id="container">
		        <div id="header">
		            <div id="title">	                    
                        <h1 class="headermaintitle"><a href="http://blogs.microsoft.co.il/blogs/tamir/">Just code - Tamir Khason</a></h1>      
                        <p id="tagline">Take care of the sense, and the sounds will take care of themselves.</p>
                    </div>
                    <div id="SubscriptionsSideBar">
                        <div id="subscriptions"> 
                            <ul>
                                <li><a href="http://feeds.feedburner.com/microsft">RSS</a></li>
	                            <li><a href="http://feeds.feedburner.com/microsft">Atom</a></li>
						        <li id="RssComments"><a href="http://blogs.microsoft.co.il/blogs/tamir/rsscomments.aspx">Comments RSS</a></li>
                            </ul>
                        </div>
                    </div>
                    <div id="nav">                    
                        <ul>
                            <li><a href="http://blogs.microsoft.co.il/blogs/tamir/">Home</a></li>
                            <li><a href="http://blogs.microsoft.co.il/blogs/tamir/contact.aspx">Contact</a></li>
                            
                            
                        </ul>
                    </div>
                </div>
                
                    <div id="contentwrapper">
		                <div id="sidebar-a">              
                            <div id="TasksSideBar">                                
                                
                                
                            </div>
                            
                            <div id="SearchSideBar">    
                                <div id="Search">
	                                        <h3>Search</h3>
                                            <ul>
                                                <li>
                                                    <input name="ctl00$SideBar$ctl01$ctl00$SearchBox" id="ctl00_SideBar_ctl01_ctl00_SearchBox" class="searchBox" button="SearchButton" onclick="if(this.defaultValue==this.value) this.value='';" onblur="if(this.value=='') this.value=this.defaultValue;" type="text">
                                                    <a id="ctl00_SideBar_ctl01_ctl00_SearchButton" class="SearchButton" href="javascript:__doPostBack('ctl00$SideBar$ctl01$ctl00$SearchButton','')">Go</a>
                                                </li>
                                            </ul>
                                    </div>
                            </div>  
                                
                                <div id="TagSideBar">
                                        <h3>Tags</h3>
                                    <ul class="SidebarTagCloud">
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Accessibility/default.aspx" rel="tag">Accessibility</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/blogging+general/default.aspx" rel="tag">blogging general</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Blogging+rules/default.aspx" rel="tag">Blogging rules</a></li>
<li class="Tag3"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/blogging+tools/default.aspx" rel="tag">blogging tools</a></li>
<li class="Tag2"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/C_2300_/default.aspx" rel="tag">C#</a></li>
<li class="Tag5"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/demos/default.aspx" rel="tag">demos</a></li>
<li class="Tag2"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/download/default.aspx" rel="tag">download</a></li>
<li class="Tag5"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/events/default.aspx" rel="tag">events</a></li>
<li class="Tag4"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/fun/default.aspx" rel="tag">fun</a></li>
<li class="Tag4"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/help/default.aspx" rel="tag">help</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/jobs/default.aspx" rel="tag">jobs</a></li>
<li class="Tag4"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Mobile/default.aspx" rel="tag">Mobile</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Performance/default.aspx" rel="tag">Performance</a></li>
<li class="Tag1"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/promo/default.aspx" rel="tag">promo</a></li>
<li class="Tag3"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Silverlight/default.aspx" rel="tag">Silverlight</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/SkyDrive/default.aspx" rel="tag">SkyDrive</a></li>
<li class="Tag1"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/soft/default.aspx" rel="tag">soft</a></li>
<li class="Tag1"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/source/default.aspx" rel="tag">source</a></li>
<li class="Tag2"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/thoughts/default.aspx" rel="tag">thoughts</a></li>
<li class="Tag1"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Tips+and+Tricks/default.aspx" rel="tag">Tips and Tricks</a></li>
<li class="Tag2"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/tools/default.aspx" rel="tag">tools</a></li>
<li class="Tag1"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/tutorial/default.aspx" rel="tag">tutorial</a></li>
<li class="Tag2"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Vista/default.aspx" rel="tag">Vista</a></li>
<li class="Tag3"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Vista+Battery+Saver/default.aspx" rel="tag">Vista Battery Saver</a></li>
<li class="Tag3"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Visual+Studio/default.aspx" rel="tag">Visual Studio</a></li>
<li class="Tag5"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/VSTS/default.aspx" rel="tag">VSTS</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/WCF/default.aspx" rel="tag">WCF</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Web/default.aspx" rel="tag">Web</a></li>
<li class="Tag5"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Windows+Gadgets/default.aspx" rel="tag">Windows Gadgets</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Windows+Live/default.aspx" rel="tag">Windows Live</a></li>
<li class="Tag6"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Windows+Live+Writer/default.aspx" rel="tag">Windows Live Writer</a></li>
<li class="Tag1"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/WPF/default.aspx" rel="tag">WPF</a></li>
<li class="Tag5"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/WPF+crossbow/default.aspx" rel="tag">WPF crossbow</a></li>
<li class="Tag5"><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/WPF_2F00_E/default.aspx" rel="tag">WPF/E</a></li>
</ul>
</div>
                              
                                
                                <div id="NewsSidebar">
                                        <h3>News</h3>
                                        <ul>
                                    <a href="http://www.linkedin.com/in/tamirk"><img src="screen%20saver%20and%20power%20management%20disabling_files/btn_profile_bluetxt_80x15.gif" alt="View Tamir Khason's profile on LinkedIn" border="0" height="15" width="80"></a>


                                        </ul>
                                    </div>                
                                                
                                
                                <div id="NavSideBar"><h3>Navigation</h3>
<ul>
<li><a href="http://blogs.microsoft.co.il/">Home</a></li><li><a href="http://blogs.microsoft.co.il/blogs/">Blogs</a></li><li><a href="http://blogs.microsoft.co.il/blogs/MainFeed.aspx">RSS</a></li>
</ul></div>
                                
                                
                                
                                
                                <div id="ArchiveSideBar"><h3>Archives</h3>
<ul>
<li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/10.aspx">October 2007 (15)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/09.aspx">September 2007 (14)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/08.aspx">August 2007 (21)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/07.aspx">July 2007 (32)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/06.aspx">June 2007 (10)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/05.aspx">May 2007 (22)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/04.aspx">April 2007 (21)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/03.aspx">March 2007 (20)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/02.aspx">February 2007 (9)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/01.aspx">January 2007 (10)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2006/12.aspx">December 2006 (11)</a></li><li><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2006/11.aspx">November 2006 (4)</a></li>
</ul></div> 
                                
                                
                                
	                    
                    </div>
                    <div id="content"><div id="content2">
	                    
    <div class="post">
        <div class="posthead">
            Tuesday, March 06, 2007 11:10 PM
            <a href="http://blogs.microsoft.co.il/members/tamir.aspx">Tamir Khason</a>
            
            <h2>
                Single instance application, screen saver and power management disabling and battery meter
                
            </h2>
        </div>        
            <p>The
first client's request was to make my WPF application single-instance
based. Really simple, remember from WinForms? Named pipes to itself,
mutexes, VB approach. First method is rather complicated, and I do not
want to put all this code into my app.xaml.cs file. The second one is
rather good, but it has security issues, so the only&nbsp;reasonable
way to&nbsp;do it is&nbsp;using VB's WindowsFormsApplicationBase
approach.</p>
<p>How? Please, before asking me, take a brief look into Windows SDK.
One of samples there speaking about it. Anyhow, all you should do is to
create Manager, derived from WindowsFormsApplicationBase (only this
class has IsSingleInstance property). All&nbsp;other stuff&nbsp;is
really straight forward.</p>
<p>Delete your app.xaml (with cs). The create new cs class and put
start point there (as well as you do it in 2.0 and 1.1 application</p>
<p>&nbsp;</p>
<blockquote>
<p>public class AppManager<br>{<br>&nbsp;&nbsp;&nbsp;&nbsp; [STAThread]<br>&nbsp;&nbsp;&nbsp;&nbsp; public static void Main(string[] args)<br>&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ApplicationManager manager = new ApplicationManager();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; manager.Run(args);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>}</p></blockquote>
<p>
</p><p>Then create new class, derrived from WindowsFormsApplicationBase
(don't forget to add reference to Microsoft.VisualBasic)&nbsp;inside
the file (or in other file if you wish and override OnStartup </p><p>
</p><blockquote>
<p>public class ApplicationManager : WindowsFormsApplicationBase<br>{<br>&nbsp;&nbsp; ManagedApplication app; 
</p><p>&nbsp;&nbsp; public ApplicationManager()<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.IsSingleInstance = true;<br>&nbsp;&nbsp; } 
</p><p>&nbsp;&nbsp; protected override bool OnStartup&nbsp;&nbsp;&nbsp;
(Microsoft.VisualBasic.ApplicationServices.StartupEventArgs eventArgs)<br>&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp; &nbsp;app = new ManagedApplication();<br>&nbsp;&nbsp;&nbsp; &nbsp;app.Run();<br>&nbsp;&nbsp;&nbsp;&nbsp; return false;<br>&nbsp;&nbsp; } 
</p><p>protected override void OnStartupNextInstance(StartupNextInstanceEventArgs eventArgs)<br>&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp; base.OnStartupNextInstance(eventArgs);<br>&nbsp;&nbsp;&nbsp;&nbsp; app.Activate();<br>&nbsp; }<br>}</p></blockquote>
<p>Next create application derived class to wake or run your application 
</p><p>
</p><blockquote>
<p>public class ManagedApplication : Application<br>{<br>&nbsp;&nbsp; protected override void OnStartup(System.Windows.StartupEventArgs e)<br>{<br>&nbsp;&nbsp; base.OnStartup(e); 
</p><p>Window1 wnd = new Window1();<br>wnd.Show();<br>} 
</p><p>internal void Activate()<br>{<br>if (!this.MainWindow.IsVisible)<br>{<br>this.MainWindow.Show();<br>} 
</p><p>if (this.MainWindow.WindowState == WindowState.Minimized)<br>{<br>this.MainWindow.WindowState = WindowState.Normal;<br>} 
</p><p>this.MainWindow.Activate();<br>this.MainWindow.Focus();<br>}<br>}</p></blockquote>
<p>That's all, folks. Now your application will run only once. Each other instance will wake, restore and activate your program 
</p><p>
</p><p>The next challenge is to prevent screen saver and power
management from appear, while my application is running. To do it,
we'll have to go deeper into WinProc and make some woodoo on system
messages (don't you did it recently) </p><p>In you main window subscribe to SourceInitialized to get your application handler (the only handler in WPF application) 
</p><p>
</p><blockquote>
<p>public Window1()<br>{<br>InitializeComponent();<br>SourceInitialized += new EventHandler(Window1_SourceInitialized);<br>}</p></blockquote>
<p>Then, get handle and hook on it's messages 
</p><blockquote>
<p>void Window1_SourceInitialized(object sender, EventArgs e)<br>{<br>((HwndSource)PresentationSource.FromVisual(this)).AddHook(myHook);<br>}</p></blockquote>
<p>Messages you need is WM_SYSCOMMAND at the beginning, and then
SC_SCREENSAVE and SC_MONITORPOWER. Simple, isn't it? The only thing you
should remember, that in WPF we can use only 4 low order bits from
wParam (read MSDN) so, our hook will looks like this </p><p>
</p><blockquote>
<p>const int WM_SYSCOMMAND = 0x112;<br>const int SC_SCREENSAVE = 0xF140;<br>const int SC_MONITORPOWER = 0xF170; 
</p><p>//we need only 4 low order bits of the wParam<br>const int lowOrderMask = 0xFFF0;<br>IntPtr myHook(IntPtr hwnd, int mgs, IntPtr wParam, IntPtr lParam, ref bool handled)<br>{<br>if (mgs == WM_SYSCOMMAND &amp;&amp;<br>((((long)wParam &amp; lowOrderMask) == SC_SCREENSAVE) ||<br>((long)wParam &amp; lowOrderMask) == SC_MONITORPOWER))<br>{<br>handled = true;<br>}<br>return IntPtr.Zero;<br>}</p></blockquote>
<p>Remember, that you are working with laptop and you really need power. So, let's make battery monitor for fun. 
</p><p><img style="border: 0px none ;" src="screen%20saver%20and%20power%20management%20disabling_files/image7.png" border="0" height="235" width="598"> 
</p><p>In order to get battery status we'll make PInvoke for
GetSystemPowerStatus from kernel. I will not explain how to do it (you
can see it in the sample attached), but I want to use WPF power to show
it. We'll do DependencyObject with a couple of read only dependency
properties. </p><blockquote>
<p>public class Battery : DependencyObject</p></blockquote>
<p>So, we have one. Let's put timer and get the battery status every second 
</p><p>
</p><blockquote>
<p>public Battery()<br>{<br>DispatcherTimer timer = new DispatcherTimer();<br>timer.Tick += new EventHandler(timer_Tick);<br>timer.Interval = TimeSpan.FromSeconds(1);<br>timer.Start();<br>}</p></blockquote>
<p>Now we need read only dependency property. For this we'll have to
create DependencyPropertyKey first. Only one, who can access those keys
will able to change the value of the property. Everything else is
really simple and looks exactly like standard DP. </p><p>
</p><blockquote>
<p>public static readonly DependencyPropertyKey BatteryStatusPropertyKey = DependencyProperty.RegisterReadOnly<br>("LineStatus", typeof(ACLineStatus), typeof(Battery),<br>new UIPropertyMetadata(ACLineStatus.Unknown)); 
</p><p>public static DependencyProperty BatteryStatusProperty = BatteryStatusPropertyKey.DependencyProperty; 
</p><p>public ACLineStatus LineStatus<br>{<br>get { return (ACLineStatus)GetValue(BatteryStatusProperty); }<br>}</p></blockquote>
<p>So, as you can see, we made readonly DP of ACLineStatus tyle and
we'll fill it this way SetValue(BatteryStatusPropertyKey,
(ACLineStatus)m_status.ACLineStatus); later. We'll can access the key,
so we can set values, all others will be able only get. </p><p>Next we'll do it for all other properties and make simple graphic indicator for this. This one: 
</p><p>
</p><blockquote>
<p>&lt;Border BorderThickness="2" BorderBrush="Black" Height="100"&gt;<br>&lt;Border.Background&gt;<br>&lt;VisualBrush Stretch="None" AlignmentX="Left"&gt;<br>&lt;VisualBrush.Visual&gt;<br>&lt;Rectangle Fill="Red" Height="100"&gt;<br>&lt;Rectangle.Width&gt;<br>&lt;MultiBinding Converter="{StaticResource pcConv}"&gt;<br>&lt;Binding Source="{StaticResource battery}"<br>Path="BatteryLifePercent"/&gt;<br>&lt;Binding ElementName="myWindow" Path="Width"/&gt;<br>&lt;/MultiBinding&gt;<br>&lt;/Rectangle.Width&gt;<br>&lt;/Rectangle&gt;<br>&lt;/VisualBrush.Visual&gt;<br>&lt;/VisualBrush&gt;<br>&lt;/Border.Background&gt;<br>&lt;/Border&gt;</p></blockquote>
<p>Now the rectangle visual as background brush will fill the relevant
space according the battery life. We'll have to scale it for window
width change, so, we'll bind to Width of out window and
BatteryLifePercent readonly DP. The converter do following </p><p>
</p><blockquote>
<p>class PercCalcConverter:IMultiValueConverter<br>{<br>#region IMultiValueConverter Members 
</p><p>public object Convert(object[] values, Type targetType, object parameter, System.Globalization.CultureInfo culture)<br>{<br>double pr = (double)values[0];<br>double max = (double)values[1]; 
</p><p>double val = pr * max / 100;<br>return val;<br>}</p></blockquote>
<p><img style="border: 0px none ;" src="screen%20saver%20and%20power%20management%20disabling_files/image6.png" border="0" height="219" width="598"> 
</p><p>That's all, for today, folks. See the attachment with full
application source (as usual) with a little surprise inside it. Going
sleep now... </p><p><a href="http://blogs.microsoft.co.il/blogs/tamir/attachment/9622.ashx">Source code for this article</a></p>  
                  
            <span id="ctl00_Main_ctl07_ctl01">Filed under: <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/WPF/default.aspx" rel="tag">WPF</a>, <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/tutorial/default.aspx" rel="tag">tutorial</a>, <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/Tips+and+Tricks/default.aspx" rel="tag">Tips and Tricks</a>, <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/source/default.aspx" rel="tag">source</a>, <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/demos/default.aspx" rel="tag">demos</a>, <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/tags/download/default.aspx" rel="tag">download</a></span><input name="ctl00$Main$ctl07$ctl01" id="ctl00_Main_ctl07_ctl01_State" value="value:Filed%20under%3A%20%3Ca%20href%3D%22%2Fblogs%2Ftamir%2Farchive%2Ftags%2FWPF%2Fdefault.aspx%22%20rel%3D%22tag%22%3EWPF%3C%2Fa%3E%2C%20%3Ca%20href%3D%22%2Fblogs%2Ftamir%2Farchive%2Ftags%2Ftutorial%2Fdefault.aspx%22%20rel%3D%22tag%22%3Etutorial%3C%2Fa%3E%2C%20%3Ca%20href%3D%22%2Fblogs%2Ftamir%2Farchive%2Ftags%2FTips%2Band%2BTricks%2Fdefault.aspx%22%20rel%3D%22tag%22%3ETips%20and%20Tricks%3C%2Fa%3E%2C%20%3Ca%20href%3D%22%2Fblogs%2Ftamir%2Farchive%2Ftags%2Fsource%2Fdefault.aspx%22%20rel%3D%22tag%22%3Esource%3C%2Fa%3E%2C%20%3Ca%20href%3D%22%2Fblogs%2Ftamir%2Farchive%2Ftags%2Fdemos%2Fdefault.aspx%22%20rel%3D%22tag%22%3Edemos%3C%2Fa%3E%2C%20%3Ca%20href%3D%22%2Fblogs%2Ftamir%2Farchive%2Ftags%2Fdownload%2Fdefault.aspx%22%20rel%3D%22tag%22%3Edownload%3C%2Fa%3E" type="hidden">
    </div>
        <div class="postfoot">
            <div><span class="em">Attachment:</span> <a href="http://blogs.microsoft.co.il/blogs/tamir/attachment/9622.ashx">SingleInstanceWPF.zip</a></div>	
      </div>
    
            
                    <a name="Comments">
                    </a><h3><a name="Comments">Comments</a></h3>
<a name="Comments">                    </a><div id="comments">
<a name="Comments">                
                    </a><div class="commentowner">
<a name="Comments">			            </a><h4>
<a name="Comments">				            </a><a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/03/06/Single-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx#9742">#</a>
				            <span>http://rrelyea.spaces.live.com/blog/cns!167ad7a5ab58d5fe!1697.entry</span>
			            </h4>
			            <div class="commentssubhead">
			                <span class="commentspan">
			                    
                            </span>
			                Thursday, March 08, 2007 6:53 PM
			                by <a title="TrackBack" href="http://rrelyea.spaces.live.com/blog/cns%21167ad7a5ab58d5fe%211697.entry">TrackBack</a>
        			        
                        </div>			
		            <div class="commentsbody">
		                
                    </div>
                
                    <div class="comment">
			            <h4>
				            <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/03/06/Single-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx#19111">#</a>
				            <span>re: Single instance application, screen saver and power management disabling and battery meter</span>
			            </h4>
			            <div class="commentssubhead">
			                <span class="commentspan">
			                    
                            </span>
			                Friday, July 13, 2007 10:17 AM
			                by c.j. anderson
        			        
                        </div>			
		            <div class="commentsbody">
		                <p></p><p>fails if password is required. &nbsp;see <a rel="nofollow" target="_new" href="http://msdn2.microsoft.com/en-us/library/ms646360.aspx">http://msdn2.microsoft.com/en-us/library/ms646360.aspx</a></p>

                    </div>
                
                    <div class="comment">
			            <h4>
				            <a href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/03/06/Single-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx#25214">#</a>
				            <span>Never ever close me - how to disable close button in WPF</span>
			            </h4>
			            <div class="commentssubhead">
			                <span class="commentspan">
			                    
                            </span>
			                Wednesday, September 26, 2007 8:07 PM
			                by <a title="TrackBack" rel="nofollow" href="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/09/26/never-ever-close-me-how-to-disable-close-button-in-wpf.aspx">Just code - Tamir Khason</a>
        			        
                        </div>			
		            <div class="commentsbody">
		                <p></p><p>Well, there is no such option in WPF. The only thing you can do is to go a bit down to unmanaged and</p>

                    </div>
                
                        </div>
                    </div>
                
            
            
            
            
                    <div id="commentform">
                    <h3>Leave a Comment</h3>
	                    <dl>
                            <dt><label for="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbTitle">Title</label> <em>(required)</em><span id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02" style="color: Red; visibility: hidden;">*</span></dt>
	                        <dd><input name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$tbTitle" value="re: Single instance application, screen saver and power management disabling and battery meter" id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbTitle" class="smallbox" type="text"></dd>

                            <dt id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_NameTitle"><label for="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbName">Name</label> <em>(required)</em><span id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10" style="color: Red; visibility: hidden;">*</span></dt>
                            <dd id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_NameDesc"><input name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$tbName" id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbName" class="smallbox" type="text"></dd>

                            <dt><label for="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbUrl">Your URL</label> <em>(optional</em>)</dt>
                            <dd><input name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$tbUrl" id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbUrl" class="smallbox" type="text"></dd>

                            <dt><label for="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbComment">Comments</label> <em>(required)</em><span id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07" style="color: Red; visibility: hidden;">*</span></dt>
                            <dd><textarea name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$tbComment" rows="5" cols="25" id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbComment"></textarea></dd>

                            <dt><input id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_chkRemember" name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$chkRemember" type="checkbox"><label for="ctl00_Main_ctl08_ctl02_ctl02_ctl02_chkRemember">Remember Me?</label></dt>
               
                            <dt><div id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_CaptchaPanel" class="Captcha_Div">
	<img src="screen%20saver%20and%20power%20management%20disabling_files/captcha.jpg" style="border-width: 0px;"><br><span>Enter the numbers above: </span><input name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$CaptchaTextBox" size="3" id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_CaptchaTextBox" type="text"><span id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13" style="color: Red; display: none;">*</span>
</div><input name="ctl00$Main$ctl08$ctl02$ctl02$ctl02$btnSubmit" value="Submit" onclick='javascript:WebForm_DoPostBackWithOptions(new WebForm_PostBackOptions("ctl00$Main$ctl08$ctl02$ctl02$ctl02$btnSubmit", "", true, "CreateCommentForm", "", false, false))' id="ctl00_Main_ctl08_ctl02_ctl02_ctl02_btnSubmit" type="submit"></dt>
	                    </dl>
                    </div>
                    
        
        
                    </div></div>
                    <div id="contentfooter">&nbsp;</div>
		        </div>
                <div id="footer">
                    
					    <div class="Copyright"><div align="center">‎©2006 Microsoft Corporation. All rights reserved.‎  <span><a href="http://www.microsoft.com/israel/info/cpyright.asp">תנאי שימוש</a> |</span><span><a href="http://www.microsoft.com/library/toolbar/3.0/trademarks/he-il.mspx">סימנים מסחריים</a> |</span><span><a href="http://www.microsoft.com/info/iw/privacy.mspx">הצהרת פרטיות</a></span></div></div>
					    
					    

                        
					            <a href="http://communityserver.org/r.ashx?j" target="_blank"><img id="ctl00_BodyFooterRegion_ctl02_ctl03_ctl00" src="screen%20saver%20and%20power%20management%20disabling_files/PoweredByCS_commercial.gif" alt="Powered by Community Server (Commercial Edition), by Telligent Systems " style="border-width: 0px;"></a>
    						
    					
					
                </div>
            </div>        
        </div>
    
<script type="text/javascript">
<!--
var Page_Validators =  new Array(document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02"), document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10"), document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07"), document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13"));
// -->
</script>

<script type="text/javascript">
<!--
var ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02 = document.all ? document.all["ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02"] : document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02");
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02.controltovalidate = "ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbTitle";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02.errormessage = "*";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02.validationGroup = "CreateCommentForm";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02.evaluationfunction = "RequiredFieldValidatorEvaluateIsValid";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl02.initialvalue = "";
var ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10 = document.all ? document.all["ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10"] : document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10");
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10.controltovalidate = "ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbName";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10.errormessage = "*";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10.validationGroup = "CreateCommentForm";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10.evaluationfunction = "RequiredFieldValidatorEvaluateIsValid";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl10.initialvalue = "";
var ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07 = document.all ? document.all["ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07"] : document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07");
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07.controltovalidate = "ctl00_Main_ctl08_ctl02_ctl02_ctl02_tbComment";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07.errormessage = "*";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07.validationGroup = "CreateCommentForm";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07.evaluationfunction = "RequiredFieldValidatorEvaluateIsValid";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl07.initialvalue = "";
var ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13 = document.all ? document.all["ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13"] : document.getElementById("ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13");
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.controltovalidate = "ctl00_Main_ctl08_ctl02_ctl02_ctl02_CaptchaTextBox";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.errormessage = "*";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.display = "Dynamic";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.validationGroup = "CreateCommentForm";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.evaluationfunction = "CustomValidatorEvaluateIsValid";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.clientvalidationfunction = "ValidateCaptcha";
ctl00_Main_ctl08_ctl02_ctl02_ctl02_ctl13.validateemptytext = "true";
// -->
</script>


<!--
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
xmlns:dc="http://purl.org/dc/elements/1.1/"
xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
<rdf:Description
rdf:about="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/03/06/Single-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx"
dc:identifier="http://blogs.microsoft.co.il/blogs/tamir/archive/2007/03/06/Single-instance-application_2C00_-screen-saver-and-power-management-disabling-and-battery-meter.aspx"
dc:title="Single instance application, screen saver and power management disabling and battery meter"
trackback:ping="http://blogs.microsoft.co.il/blogs/tamir/trackback.ashx?PostID=9622" />
</rdf:RDF>
-->
<script src="screen%20saver%20and%20power%20management%20disabling_files/microsft.js" type="text/javascript" charset="utf-8"></script><script type="text/javascript" charset="utf-8" src="screen%20saver%20and%20power%20management%20disabling_files/site-tracker.js"></script> <script type="text/javascript">
// <![CDATA[
Telligent_Modal.Configure('/utility/loading.htm',['Modal'],['ModalTitle'],['ModalClose'],['ModalContent'],['ModalFooter'],['ModalResize'],['ModalMask'],100);
// ]]>
</script><script type="text/javascript">
// <![CDATA[
window.ctl00_Main_ctl07_ctl01 = new Telligent_InlineEditorPanel('ctl00_Main_ctl07_ctl01','ctl00_Main_ctl07_ctl01','ctl00_Main_ctl07_ctl01_State','ctl00_Main_ctl07_ctl00',false,null,null,null);
// ]]>
</script>
<script type="text/javascript">
<!--
var Page_ValidationActive = false;
if (typeof(ValidatorOnLoad) == "function") {
    ValidatorOnLoad();
}

function ValidatorOnSubmit() {
    if (Page_ValidationActive) {
        return ValidatorCommonOnSubmit();
    }
    else {
        return true;
    }
}
// -->
</script>
        
</div></div></form></body></html>